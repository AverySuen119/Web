<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Search Animal Welfare Events</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Search Animal Welfare Events</h1>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/search.html">Search Events</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="search-section">
      <form id="search-form" class="search-form">
        <div class="form-row">
          <label>Year:
            <select id="year" name="year"><option value="">Any</option></select>
          </label>
          <label>Month:
            <select id="month" name="month"><option value="">Any</option></select>
          </label>
          <label>Day:
            <select id="day" name="day"><option value="">Any</option></select>
          </label>
        </div>
        <div class="form-row">
          <label>Location:
            <input type="text" id="location" name="location" placeholder="Enter city or park">
          </label>
          <label>Category:
            <select id="category" name="category"><option value="">All Categories</option></select>
          </label>
        </div>
        <div class="form-row">
          <button type="submit" class="btn">Search</button>
          <button type="button" id="clear-filters" class="btn btn-secondary">Clear Filters</button>
        </div>
      </form>

      <div id="events-container" class="cards"></div>
      <div id="events-empty" class="empty" hidden>No events found.</div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>© Paws & Whiskers • Adress: 10 Charity St, Petville</p>
    </div>
  </footer>

  <script type="module">
    import { searchEvents, getCategories } from './js/api.js';

    const form = document.getElementById('search-form');
    const container = document.getElementById('events-container');
    const emptyEl = document.getElementById('events-empty');
    const clearBtn = document.getElementById('clear-filters');
    const categorySelect = document.getElementById('category');
    const yearSelect = document.getElementById('year');
    const monthSelect = document.getElementById('month');
    const daySelect = document.getElementById('day');

    // 填充年份、月份、日期
    function loadDateSelectors() {
      for (let y = 2024; y <= 2026; y++) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearSelect.appendChild(opt);
      }
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m.toString().padStart(2,'0'); opt.textContent = m;
        monthSelect.appendChild(opt);
      }
      for (let d = 1; d <= 31; d++) {
        const opt = document.createElement('option');
        opt.value = d.toString().padStart(2,'0'); opt.textContent = d;
        daySelect.appendChild(opt);
      }
    }

    // 填充类别下拉
    async function loadCategories() {
      try {
        const cats = await getCategories();
        cats.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.category_id;
          opt.textContent = c.name;
          categorySelect.appendChild(opt);
        });
      } catch (err) { console.error('Failed to load categories', err); }
    }

    // 渲染事件列表
    function renderEvents(results) {
      container.innerHTML = '';
      if (!results || results.length === 0) {
        emptyEl.hidden = false; return;
      }
      emptyEl.hidden = true;
      results.forEach(ev => {
        const card = document.createElement('article');
        card.className = 'card';
        const evDate = new Date(ev.event_date).toLocaleDateString();
        const price = ev.is_free ? 'Free' : `$${Number(ev.price).toFixed(2)}`;
        card.innerHTML = `
          <h3 class="card-title">${ev.name}</h3>
          <p class="meta"><strong>Date:</strong> ${evDate} • <strong>Location:</strong> ${ev.location_name}</p>
          <p class="meta"><strong>Category:</strong> ${ev.category_name} • <strong>Price:</strong> ${price}</p>
          <p class="desc">${ev.short_desc || ''}</p>
          <button class="btn" onclick="window.location.href='/event.html?id=${ev.event_id}'">View Details</button>
        `;
        container.appendChild(card);
      });
    }

    // 表单提交
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const year = yearSelect.value;
      const month = monthSelect.value;
      const day = daySelect.value;
      const location = document.getElementById('location').value.trim();
      const category = categorySelect.value;

      try {
        container.innerHTML = '<p class="loading">Loading events…</p>';
        const results = await searchEvents({ year, month, day, location, category });
        renderEvents(results);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<p class="error">Failed to load events.</p>';
      }
    });

    // 清空表单
    clearBtn.addEventListener('click', () => {
      form.reset();
      container.innerHTML = '';
      emptyEl.hidden = true;
    });

    loadDateSelectors();
    loadCategories();
  </script>
</body>
</html>
